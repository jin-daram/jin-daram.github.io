{"componentChunkName":"component---src-templates-post-jsx","path":"/query-plan-analysis/","result":{"data":{"site":{"siteMetadata":{"title":"Let's solve it"}},"markdownRemark":{"id":"4f994ee6-e418-58a7-8365-6da206920a84","excerpt":"네이버에서 가장 많이 방문하는 주소는 뭘까요?  보통 https://naver.com 으로 접속하는 경우가 가장 많습니다. 그렇기 때문에 메인 페이지 접속 시 호출되는 API가 느리다면 사용자 경험에 큰 영향을 줄 수밖에 없습니다. 실무에서 개발한 서비스도 메인 페이지에서 여러 API를 호출하고 있었고, 단순 캐싱 수준을 넘어 쿼리 플랜에 대한 분석을 통…","html":"<p><a href=\"https://naver.com\">네이버</a>에서 가장 많이 방문하는 주소는 뭘까요? </p>\n<p><a href=\"https://www.semrush.com/website/top/south-korea/all/\">보통 https://naver.com 으로 접속하는 경우가 가장 많습니다.</a> 그렇기 때문에 메인 페이지 접속 시 호출되는 API가 느리다면 사용자 경험에 큰 영향을 줄 수밖에 없습니다.</p>\n<p>실무에서 개발한 서비스도 메인 페이지에서 여러 API를 호출하고 있었고, 단순 캐싱 수준을 넘어 쿼리 플랜에 대한 분석을 통해 개선한 경험을 소개드리려고 합니다. </p>\n<h2 id=\"피드-API-개선\" style=\"position:relative;\"><a href=\"#%ED%94%BC%EB%93%9C-API-%EA%B0%9C%EC%84%A0\" aria-label=\"피드 API 개선 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>피드 API 개선</h2>\n<hr>\n<p>성능을 실질적으로 개선하기 전에 문제의 원인을 분석해볼 수 있는 방법 중 하나가 데이터베이스로 전달되는 쿼리를 분석하는 것 입니다. 데이터베이스로 전달된 쿼리가 옵티마이저에 의해 어떤 실행 계획을 가지고 데이터를 찾았는지 알게 된다면 쿼리 개선에 도움이 될 수 있습니다. </p>\n<p><em>(쿼리를 보기 좋게 다듬은 결과이며, Spring Boot 기준 Hibernate 에 의해 생성된 쿼리가 전송되기 때문에 아래 쿼리 플랜과 비교하여 Alias 와 같은 차이점은 있으나, 구조는 동일합니다.)</em></p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> a<span class=\"token punctuation\">.</span>id\n<span class=\"token keyword\">FROM</span> article a\n\t<span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">OUTER</span> <span class=\"token keyword\">JOIN</span> article_tag tag1 <span class=\"token keyword\">ON</span> a<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> tag1<span class=\"token punctuation\">.</span>article_id\n\t<span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">OUTER</span> <span class=\"token keyword\">JOIN</span> article_tag tag2 <span class=\"token keyword\">ON</span> tag1<span class=\"token punctuation\">.</span>tag_id <span class=\"token operator\">=</span> tag2<span class=\"token punctuation\">.</span>id\n<span class=\"token keyword\">WHERE</span> <span class=\"token punctuation\">(</span> a<span class=\"token punctuation\">.</span>user_id <span class=\"token operator\">=</span> ? <span class=\"token operator\">OR</span> tag2<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> ? <span class=\"token punctuation\">)</span>\n\t<span class=\"token operator\">AND</span> <span class=\"token punctuation\">(</span> a<span class=\"token punctuation\">.</span>category_id <span class=\"token operator\">IN</span> <span class=\"token punctuation\">(</span> ?<span class=\"token punctuation\">,</span> ?<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span>\n\t<span class=\"token operator\">AND</span> a<span class=\"token punctuation\">.</span>is_deleted <span class=\"token operator\">=</span> ?\n\t<span class=\"token operator\">AND</span> a<span class=\"token punctuation\">.</span>is_block <span class=\"token operator\">=</span> ?\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> a<span class=\"token punctuation\">.</span>id\n<span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> a<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">DESC</span></code></pre></div>\n<p>위 쿼리는 병목이 발생한다고 여겨지는 쿼리입니다. 해당 쿼리를 분석하기 위해 <code class=\"language-text\">PostgreSQL</code> 기준 <code class=\"language-text\">EXPLAIN ANALYZE</code> 구문을 추가해주도록 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">EXPLAIN</span> <span class=\"token keyword\">ANALYZE</span>\n<span class=\"token keyword\">SELECT</span> a<span class=\"token punctuation\">.</span>id\n<span class=\"token keyword\">FROM</span> article a\n\t<span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">OUTER</span> <span class=\"token keyword\">JOIN</span> article_tag tag1 <span class=\"token keyword\">ON</span> a<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> tag1<span class=\"token punctuation\">.</span>article_id\n\t<span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">OUTER</span> <span class=\"token keyword\">JOIN</span> article_tag tag2 <span class=\"token keyword\">ON</span> tag1<span class=\"token punctuation\">.</span>tag_id <span class=\"token operator\">=</span> tag2<span class=\"token punctuation\">.</span>id\n<span class=\"token keyword\">WHERE</span> <span class=\"token punctuation\">(</span> a<span class=\"token punctuation\">.</span>user_id <span class=\"token operator\">=</span> ? <span class=\"token operator\">OR</span> tag2<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> ? <span class=\"token punctuation\">)</span>\n\t<span class=\"token operator\">AND</span> <span class=\"token punctuation\">(</span> a<span class=\"token punctuation\">.</span>category_id <span class=\"token operator\">IN</span> <span class=\"token punctuation\">(</span> ?<span class=\"token punctuation\">,</span> ?<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span>\n\t<span class=\"token operator\">AND</span> a<span class=\"token punctuation\">.</span>is_deleted <span class=\"token operator\">=</span> ?\n\t<span class=\"token operator\">AND</span> a<span class=\"token punctuation\">.</span>is_block <span class=\"token operator\">=</span> ?\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> a<span class=\"token punctuation\">.</span>id\n<span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> a<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">DESC</span></code></pre></div>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/0e50d055870fdc35fc654b009434bb97/cb866/query-plan-result.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 45.88235294117647%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABIUlEQVR42mWSW5aEIAxE3Y1vUREBEV/731OGikLrmY/qRGwuVZHMWEvLspD3nuZ5JiklTdNEs1KkgtBDsUdt25aKoqCyLD+qqooyIQTDtm3jqvXMG4e+J7zrQx2GgWvshegS4K26rilDs66ejuNgKHpUaxd2O45jgv2Agtebpv64Y2Ce5xz1uq4E3fednHPJbde1Qd0/NU3D8SEAAc7wgwWOHbQHIKDGmFvWMNyGWePZPjPH2lt4h0Q3MJzk3Jo2YgMqnMcPBSEuosI13L3jfmYIaa3D/H5Q5xZa/crrgEgZdYPjfAGJcRMQD5gJXG6b5xkienQK6ScuDuD42gSn8jls4g/G1+b92fFnH1xinnCKep5nuqNKzXwP7159rlR0+gdYHB+DZsGp7AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='query plan result' title='' src='/static/0e50d055870fdc35fc654b009434bb97/ca1dc/query-plan-result.png' srcset='/static/0e50d055870fdc35fc654b009434bb97/e7570/query-plan-result.png 170w,\n/static/0e50d055870fdc35fc654b009434bb97/f46e7/query-plan-result.png 340w,\n/static/0e50d055870fdc35fc654b009434bb97/ca1dc/query-plan-result.png 680w,\n/static/0e50d055870fdc35fc654b009434bb97/02d09/query-plan-result.png 1020w,\n/static/0e50d055870fdc35fc654b009434bb97/cb866/query-plan-result.png 1056w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>처음 본다면 다소 당황스러울 수 있습니다. 그래서 가장 먼저 읽는 순서를 알아야 합니다. 그래야 어떤 방식으로 데이터를 조회하는지에 대한 쿼리 실헹 계획을 알아갈 수 있습니다. 실행 계획이 조금 길기 때문에 여러 구역으로 분리해서 알아보도록 합니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/07ab5699eee14ef4d80aff3e7f32971d/7f607/divide-query-result.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 45.88235294117647%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAABVElEQVR42lXNWW+CQBQFYP5SW43swqDDAKIs1idtWn2o7JuKpn++h442bfLl5jDMuSOcdP1sGD0hrabVigKNqsKQVXyq/CSbTI6jUfJHOh4LhSiiebUIZqcP/UqWSmlQyTKUkohZSCJuJ+P/ZaJsVyyNvSJwMoTQzX16dMwDMw50+sHZxn6uvzNjbylvprwFIu+IshOeponstCS4Gct+6l8wVbeTWCPa9YjkI5L9uIcXMx0myZ7N9NlIBOXT1RKPNmtg3cZuX60qnFUR4GRex7M6mtUxAr9D2wH+mvlKUAuqlYz2oX0N6SVAmF9W1skHs/V+kW6hlwyXOa20QVBzG+bngF1j1sf0Etp9hIwT0vikXT4g+2bja4Wj5Yy3hrKSUb10nNsa3K+Ne1uzPsIKLMIKmJ1WPJNmYdSe2SymlXsvc1a7tB8d/jgmXrO6JYfMm8Bf/gZI0qzfrn2yKAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='divide query result' title='' src='/static/07ab5699eee14ef4d80aff3e7f32971d/ca1dc/divide-query-result.png' srcset='/static/07ab5699eee14ef4d80aff3e7f32971d/e7570/divide-query-result.png 170w,\n/static/07ab5699eee14ef4d80aff3e7f32971d/f46e7/divide-query-result.png 340w,\n/static/07ab5699eee14ef4d80aff3e7f32971d/ca1dc/divide-query-result.png 680w,\n/static/07ab5699eee14ef4d80aff3e7f32971d/02d09/divide-query-result.png 1020w,\n/static/07ab5699eee14ef4d80aff3e7f32971d/9d567/divide-query-result.png 1360w,\n/static/07ab5699eee14ef4d80aff3e7f32971d/7f607/divide-query-result.png 2112w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<h3 id=\"초록색-구역\" style=\"position:relative;\"><a href=\"#%EC%B4%88%EB%A1%9D%EC%83%89-%EA%B5%AC%EC%97%AD\" aria-label=\"초록색 구역 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>초록색 구역</h3>\n<hr>\n<p>가장 먼저 <code class=\"language-text\">초록색 구간</code>에 대해 알아보는 이유는 보통 위에서 아래로 절차적으로 실행되는 것이라고 생각할 수 있겠지만 쿼리 플랜은 그렇지 않습니다. 각각의 작업들은 일련의 계층 구조를 가지며 부분적으로 절차적으로 진행됩니다. </p>\n<p>그 말은 즉, 어떠한 계층이 여러 하위 계층들을 가진다면 그 하위 계층들은 순차적으로 실행된다는 의미입니다. 각각의 계층은 화살표 (→) 로 구분되는데, <code class=\"language-text\">파란색 계층</code> 아래에는 2개의 계층이 존재합니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/8b670ef5123a24704aff9cb9b1f20c66/7f607/blue-has-two-depth.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 45.88235294117647%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAABYUlEQVR42lXNa0+DMBQGYH6Tbhn3lRbawsZtTD+pUfdlAwoUtsHin/dg1WjypHkLfc/Rzq57QWjEuHeczrKAtG0wZxuutvpSrVbHxeL0R7lcakLXR4IngqE/uHO/NY3GmLWmCRpDh1MYOrw+Lf+XPfMpYWWxEVlYpbzMozqmx9A7cHSg6zeFoffAfeXonVgv8B5g8xlbz9qSCGdzwdmEkmkdX1Ey2tFgcKmzboHrBa6+fId7r5xPXN155R06aUTkWGSBLJh84MMj6x9Im/vtDlC5D7rC73Z+V0CA66yfwV+vTrVgSP0hDsaMTTm9ZnTMg2tKzjHw+s0vPGzdhtuCKk7DgOY2kSvC4JyF056PBb3mbNzxqQguGZYx7pMfkGNPxo4InZrbNQOaVVOrom4Thrc9iD4eoxtM2cEIGAQjgH9OVcZyi7qNJ7frNprLagYgfcJ+Omo5nLCNDIkCWTWB2vwJtoatRffJR+EAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='blue has two depth' title='' src='/static/8b670ef5123a24704aff9cb9b1f20c66/ca1dc/blue-has-two-depth.png' srcset='/static/8b670ef5123a24704aff9cb9b1f20c66/e7570/blue-has-two-depth.png 170w,\n/static/8b670ef5123a24704aff9cb9b1f20c66/f46e7/blue-has-two-depth.png 340w,\n/static/8b670ef5123a24704aff9cb9b1f20c66/ca1dc/blue-has-two-depth.png 680w,\n/static/8b670ef5123a24704aff9cb9b1f20c66/02d09/blue-has-two-depth.png 1020w,\n/static/8b670ef5123a24704aff9cb9b1f20c66/9d567/blue-has-two-depth.png 1360w,\n/static/8b670ef5123a24704aff9cb9b1f20c66/7f607/blue-has-two-depth.png 2112w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p> <code class=\"language-text\">Seq Scan on article article0_</code> 로 시작하는 작업은 첫 번째 하위 계층이기 때문에 가장 먼저 실행됩니다.\n작업이 끝나면 다음 하위 계층인 <code class=\"language-text\">Seq Scan on article_tag tags1_</code> 작업이 실행됩니다.</p>\n<p>이제 번호를 통해 어떤 순서로 시작하는 지 감을 잡아보도록 하겠습니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/6df5fd1a9aa54c872b12139f06d03800/7f607/query-plan-sequence.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 25.294117647058822%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA0ElEQVR42lWPaRKCMAyFuRfigtJSBdkcL+GCogh47R4g5kXK6I/XZl6SL4kX1MaGTWpVX1jdlzZ+VzYeSqu6YlQuPvKInQ9P6nvUVzbiXPhIrTe/GtJtQVxEnCT1Kkh3JUVtTuvHXsQDaXVPvmoS9lJC3+ysJwWXWDzPPytSz5xihpjhINI/McAAOrgb4IYAAhig/kkxkJ9VvaOkP9KmzcjwlgBN275K+QGGNs/sG/MSAC5vO/kX9Vagnls5vKfSHOH8EQI5MPJ/p48QAB0MwA9FUMh2t/k0fAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='query plan sequence' title='' src='/static/6df5fd1a9aa54c872b12139f06d03800/ca1dc/query-plan-sequence.png' srcset='/static/6df5fd1a9aa54c872b12139f06d03800/e7570/query-plan-sequence.png 170w,\n/static/6df5fd1a9aa54c872b12139f06d03800/f46e7/query-plan-sequence.png 340w,\n/static/6df5fd1a9aa54c872b12139f06d03800/ca1dc/query-plan-sequence.png 680w,\n/static/6df5fd1a9aa54c872b12139f06d03800/02d09/query-plan-sequence.png 1020w,\n/static/6df5fd1a9aa54c872b12139f06d03800/9d567/query-plan-sequence.png 1360w,\n/static/6df5fd1a9aa54c872b12139f06d03800/7f607/query-plan-sequence.png 2112w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<ol>\n<li><code class=\"language-text\">Filter</code> 를 보면 조건절이 있습니다. Article 테이블을 <code class=\"language-text\">Seq Scan (Full Scan)</code> 하여 해당 조건에 적합한 <code class=\"language-text\">article</code> 데이터를 조회합니다.</li>\n<li><code class=\"language-text\">LEFT JOIN</code> 을 위해 article_tag 테이블의 데이터를 스캔합니다.</li>\n<li><code class=\"language-text\">LEFT JOIN</code> 을 위해 tag 테이블의 데이터를 스캔합니다.</li>\n<li><code class=\"language-text\">JOIN</code> 을 위해 <code class=\"language-text\">Hash Table</code> 을 생성합니다.</li>\n<li><code class=\"language-text\">article_tag</code> 테이블과 <code class=\"language-text\">tag</code> 테이블을 조인합니다.</li>\n<li><code class=\"language-text\">JOIN</code> 을 하기 위한 <code class=\"language-text\">Hash Table</code> 을 생성합니다.</li>\n</ol>\n<h3 id=\"파란색-구역\" style=\"position:relative;\"><a href=\"#%ED%8C%8C%EB%9E%80%EC%83%89-%EA%B5%AC%EC%97%AD\" aria-label=\"파란색 구역 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>파란색 구역</h3>\n<hr>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/45b04a5c94d72e570040e41f52ab2800/7f607/blue-section.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 8.823529411764705%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAIAAADXZGvcAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAVElEQVR42mOwdSty9q108i4HIkevMle/KhffSjv3YqC4jWuRtUuBjWshkA1hAElTuyw4YrB0ynf2qQAioE4gAmqzcs43d8gxc8gxsk7HRMY2GXAEABCQJOR6kXQQAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='blue section' title='' src='/static/45b04a5c94d72e570040e41f52ab2800/ca1dc/blue-section.png' srcset='/static/45b04a5c94d72e570040e41f52ab2800/e7570/blue-section.png 170w,\n/static/45b04a5c94d72e570040e41f52ab2800/f46e7/blue-section.png 340w,\n/static/45b04a5c94d72e570040e41f52ab2800/ca1dc/blue-section.png 680w,\n/static/45b04a5c94d72e570040e41f52ab2800/02d09/blue-section.png 1020w,\n/static/45b04a5c94d72e570040e41f52ab2800/9d567/blue-section.png 1360w,\n/static/45b04a5c94d72e570040e41f52ab2800/7f607/blue-section.png 2112w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>이제까지 기본적인 조건과 적합한 <code class=\"language-text\">article</code> 데이터를 조회했고, <code class=\"language-text\">article_tag</code> 테이블과 <code class=\"language-text\">tag</code> 테이블을 <code class=\"language-text\">JOIN</code> 한 <code class=\"language-text\">Hash Table</code> 을 생성했습니다. 그리고 <code class=\"language-text\">파란색 구역</code> 은 JOIN을 하게 되는 구간입니다.</p>\n<p>그 과정에서\n<code class=\"language-text\">article.user_id = ? OR tag.id = ?</code>\n조건절을 만족하는 레코드를 필터링 하게 됩니다. 이 과정을 <code class=\"language-text\">파란색 구역</code>에서 수행하게 됩니다.</p>\n<h3 id=\"빨간색-구간\" style=\"position:relative;\"><a href=\"#%EB%B9%A8%EA%B0%84%EC%83%89-%EA%B5%AC%EA%B0%84\" aria-label=\"빨간색 구간 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>빨간색 구간</h3>\n<hr>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/c4ed62f8658aa4c73e2f92f71b95c442/7f607/red-section.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 11.176470588235293%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAIAAADXZGvcAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAUElEQVR42mMotrcvd3KqdHEpsbcvtLEpsLEpsrUFMkAIyACzgSI55uaZJibIKMvUlCHXwqLC2RmoucLJqdjOrsDaGigCVApH2TASTXOmqSkAn9sjQyxOZRgAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='red section' title='' src='/static/c4ed62f8658aa4c73e2f92f71b95c442/ca1dc/red-section.png' srcset='/static/c4ed62f8658aa4c73e2f92f71b95c442/e7570/red-section.png 170w,\n/static/c4ed62f8658aa4c73e2f92f71b95c442/f46e7/red-section.png 340w,\n/static/c4ed62f8658aa4c73e2f92f71b95c442/ca1dc/red-section.png 680w,\n/static/c4ed62f8658aa4c73e2f92f71b95c442/02d09/red-section.png 1020w,\n/static/c4ed62f8658aa4c73e2f92f71b95c442/9d567/red-section.png 1360w,\n/static/c4ed62f8658aa4c73e2f92f71b95c442/7f607/red-section.png 2112w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>빨간색 구간은 그 이후에 있는 <code class=\"language-text\">ORDER BY</code>, <code class=\"language-text\">GROUP BY</code> 를 수행하게 됩니다. </p>\n<h3 id=\"성능-추적\" style=\"position:relative;\"><a href=\"#%EC%84%B1%EB%8A%A5-%EC%B6%94%EC%A0%81\" aria-label=\"성능 추적 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>성능 추적</h3>\n<hr>\n<p>이제까지 유저 피드 조회 시에 실행되는 쿼리에 대해 분석해봤습니다. 이제 쿼리를 실행하게 되면 실제로 어떤 순서와 방법으로 데이터를 조회하는지 간략하게나마 알게되었고, 마지막에는 현재 테이블의 데이터를 기준으로 실행되는 쿼리의 시간을 알 수 있습니다. </p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 206px; '>\n      <a class='gatsby-resp-image-link' href='/static/f955b43529ac4b1c613298a145cf4b85/56061/query-execution-time.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 27.647058823529413%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABSUlEQVR42j2Q23aCQAxF+RYFlgxIwaLghYtFC1hBQBRE7Gof6v//wWmYah9mnUn2JDkTwTQMyJKE4XAIiVSWZQwGA64T0+Tasz7HGINCZzwew5yYPBZFkXNR/KsV2qZG215R1zWSZI88S9F1VwSBjzDcoKoqXIinHztYlgXX83DIc9zvP9hu37Fev6G9NJhNp3yoINEEy5rCMA2arENlKjULYNOD3rGu6+Rm8u9WVTUYLwZ0ctm7HY0Uqn8FUxTuVNjT5OVyCc/14DgOojjGynWxWMxJPaTpHivige8TtxFFMXa7BL4fIC9KFIcMtj2DH6yphwvhfD6hu93o2y3KosDnrUPdtPzrjjNHWZbUNMP39xfiKEKa5UjiCHGS0JoaVMQ3YYiiPOJ8OkJQyKqqqnzBmqZBURi/s8fyn6zP97yPe32yZ8wefX4BxXzJTqQmSrwAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='실제 쿼리 실행 시간은 Execution Time: 67.285ms' title='' src='/static/f955b43529ac4b1c613298a145cf4b85/56061/query-execution-time.png' srcset='/static/f955b43529ac4b1c613298a145cf4b85/e7570/query-execution-time.png 170w,\n/static/f955b43529ac4b1c613298a145cf4b85/56061/query-execution-time.png 206w' sizes='(max-width: 206px) 100vw, 206px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>실제 쿼리 실행 시간은 Execution Time: 67.285ms</figcaption>\n  </figure></p>\n<p>다만 우리가 궁금한 건 어떤 순서로 작업을 진행하는지가 아닙니다. 최종적으로 생성된 쿼리가 얼마나 효율적으로 높은 성능으로 데이터를 조회해오는지이고, 그렇지 못한다면 어떤 곳에서 성능적으로 유실이 많은 지 알아내는 것 입니다. </p>\n<p>다행히 쿼리 플랜에서 쉽게 병목 구간을 알아낼 수 있습니다. 쿼리 플랜을 보다 보면 <code class=\"language-text\">cost</code> 라는 것이 있다는 것을 알 수 있습니다. 이는 절대적 지표가 아닌, 해당 작업을 수행하는데 상대적인 비용이 얼만큼 들었느냐에 대한 지표입니다. </p>\n<p>그럼 가장 <code class=\"language-text\">cost</code> 가 높게 측정되는 구간은 어디일까요?</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/bbdb9dbdd02fa3178984861065dc6caa/7f607/high-cost-section.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 7.0588235294117645%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAIAAABR8BlyAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAMElEQVR42mPQ0tLS09OztbWztbW1BwMrKysLMLC0tASS5ubmIDaMawkGZmZmhoaGAI9TDRdHebXXAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='high cost section' title='' src='/static/bbdb9dbdd02fa3178984861065dc6caa/ca1dc/high-cost-section.png' srcset='/static/bbdb9dbdd02fa3178984861065dc6caa/e7570/high-cost-section.png 170w,\n/static/bbdb9dbdd02fa3178984861065dc6caa/f46e7/high-cost-section.png 340w,\n/static/bbdb9dbdd02fa3178984861065dc6caa/ca1dc/high-cost-section.png 680w,\n/static/bbdb9dbdd02fa3178984861065dc6caa/02d09/high-cost-section.png 1020w,\n/static/bbdb9dbdd02fa3178984861065dc6caa/9d567/high-cost-section.png 1360w,\n/static/bbdb9dbdd02fa3178984861065dc6caa/7f607/high-cost-section.png 2112w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>해당 작업이 다른 작업들과 <code class=\"language-text\">cost</code> 를 비교했을 때, 가장 높은 <code class=\"language-text\">cost</code> 를 나타내고 있음을 알 수 있습니다. 또한 <code class=\"language-text\">cost</code> 정보 외에도, <code class=\"language-text\">actrual time</code>, <code class=\"language-text\">rows</code> 와 같은 간접적 지표를 통해 작업의 성능을 추측할 수 있습니다.</p>\n<p>위 작업에 대해 설명하자면, 기본적인 조건절을 통해 article 데이터를 조회한 결과, 64276개 달하는 데이터를 조회했습니다. 이는 <code class=\"language-text\">Seq Scan (Full Scan)</code> 이기 때문에 Index 를 타지 않고, 조회해온다는 것을 알 수 있습니다.</p>\n<ul>\n<li><code class=\"language-text\">category_id IN ( ?, ? )</code></li>\n<li><code class=\"language-text\">is_deleted = false</code></li>\n<li><code class=\"language-text\">is_blocked = false</code></li>\n</ul>\n<p>정리하자면 위 조건들이 적용된 쿼리가 Article 테이블을 풀 스캔하여 64276개의 데이터를 조회하게 됩니다.\n그리고 원래 쿼리의 조건절을 다시 보게 되면 위 조건절은 제외하고도 한 가지의 조건절이 더 포함되어 있습니다.</p>\n<ul>\n<li><code class=\"language-text\">( a.user_id = ? OR t.id = ? )</code></li>\n</ul>\n<p>위 두 조건 모두 피드를 구분 짓는 중요한 조건들입니다. 전자는 <code class=\"language-text\">팔로우 한 크리에이터들의 article</code>을 구분지을 때 사용하는 조건절이고, 후자는 사용자가 등록한 <code class=\"language-text\">관심 태그 ID</code> 가 들어가는 조건입니다. 그리고 이 둘을 모두 포함하도록 <code class=\"language-text\">OR 연산자</code> 가 붙었습니다.</p>\n<p>즉 <code class=\"language-text\">t.id = ?</code> 이 구간 때문에 <code class=\"language-text\">a.user_id</code> 로 인덱스를 타려고 하지만 <code class=\"language-text\">OR 연산자</code> 때문에 <code class=\"language-text\">t.id = ?</code> 도 포함하는 Article도 가져와야 하기 때문에 인덱스를 타지 못하고, <code class=\"language-text\">Table Full Scan</code> 을 하게 되어 병목이 발생하게 됩니다.</p>\n<p>지금은 <code class=\"language-text\">article</code> 테이블의 전체 데이터 수가 6만여건 밖에 되자 않아, 별로 크게 성능을 저하시키지 않는 것처럼 보이지만, 데이터가 많아지게 되면 치명적입니다.</p>\n<blockquote>\n<p><strong>각각 <code class=\"language-text\">category_id</code> , <code class=\"language-text\">is_deleted</code>, <code class=\"language-text\">is_blocked</code>  인덱스를 생성하면 되지 않을까?</strong></p>\n<p>하지만 해당 인덱스를 생성해도 결과는 똑같습니다. (복합 인덱스라면 이야기가 다를 수 있다.) <code class=\"language-text\">PostgreSQL</code> 은 조회하는 데이터가 해당 테이블의 많은 부분을 차지하면, Index가 아닌 Full-Scan을 통해 데이터를 조회합니다. (카디널리티가 낮으면 인덱스 효과가 떨어지기 때문에)</p>\n</blockquote>\n<p>그럼 쿼리 플랜을 통해 병목 구간을 확인했으니, 개선 방법을 알아봅시다.</p>\n<h3 id=\"쿼리-개선\" style=\"position:relative;\"><a href=\"#%EC%BF%BC%EB%A6%AC-%EA%B0%9C%EC%84%A0\" aria-label=\"쿼리 개선 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>쿼리 개선</h3>\n<hr>\n<p>위 쿼리를 실행하면 약 <code class=\"language-text\">67ms</code> 의  시간이 소요되었습니다. 전혀 길지 않은 실행시간이지만, 더 단축시키게 되면 많은 요청이 몰렸을 때나 데이터가 많아졌을 때, 하나의 \b트랜잭션 자체에 Connection을 물고 있는 시간을 개선 할 수 있습니다.</p>\n<p>아직 효율적인 쿼리 작성에 미숙하기에, 가장 빨리 데이터를 조회할 수 있는 방법을 선택했습니다.</p>\n<p>우선 해당 쿼리를 인덱스를 타는 방향으로 개선하는게 좋아보였습니다. 현재 쿼리는 너무나 많은 <code class=\"language-text\">article</code> 을 조회하기 때문에 적절한 개수의 <code class=\"language-text\">article</code> 을 조회하도록 개선이 필요했습니다. 즉 <code class=\"language-text\">user_id</code> 에 대한 <strong>인덱스</strong>를 타게끔 유도해야 합니다.</p>\n<p><strong>그래서 쿼리를 분리하기로 결정했습니다.</strong></p>\n<p><code class=\"language-text\">article_tag</code> 와 <code class=\"language-text\">tag</code> 테이블을 조인하지 않고, <code class=\"language-text\">user_id</code> 처럼 유저가 가지고 있는 관심 태그를 기반한 <code class=\"language-text\">article</code> 의 <code class=\"language-text\">id</code> 를 인자로 받아서 다음과 같은 쿼리로 개선하기로 하였습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> a<span class=\"token punctuation\">.</span>id\n<span class=\"token keyword\">FROM</span>   article a\n<span class=\"token keyword\">WHERE</span>  <span class=\"token punctuation\">(</span> a<span class=\"token punctuation\">.</span>user_id <span class=\"token operator\">=</span> ? <span class=\"token operator\">OR</span> a<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> ? <span class=\"token punctuation\">)</span>\n       <span class=\"token operator\">AND</span> <span class=\"token punctuation\">(</span> a<span class=\"token punctuation\">.</span>category_id <span class=\"token operator\">IN</span> <span class=\"token punctuation\">(</span> ?<span class=\"token punctuation\">,</span> ? <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span>\n       <span class=\"token operator\">AND</span> a<span class=\"token punctuation\">.</span>is_deleted <span class=\"token operator\">=</span> ?\n       <span class=\"token operator\">AND</span> a<span class=\"token punctuation\">.</span>is_block <span class=\"token operator\">=</span> ?\n<span class=\"token keyword\">GROUP</span>  <span class=\"token keyword\">BY</span> a<span class=\"token punctuation\">.</span>id\n<span class=\"token keyword\">ORDER</span>  <span class=\"token keyword\">BY</span> a<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">DESC</span></code></pre></div>\n<p>쿼리가 훨씬 간단해졌습니다. 이런식으로 쿼리를 튜닝하게 되면 <code class=\"language-text\">user_id</code> 와 <code class=\"language-text\">id</code> 가 Index를 타게 되어, 전보다 훨씬 빠른 속도로 데이터를 조회하게 되어, 성능이 향상됩니다. 이 결과 역시 쿼리 플랜을 통해 확인할 수 있습니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/f1eca4cc692652b7660fad5cce349c81/c3ac1/fix-query-result.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 38.82352941176471%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABA0lEQVR42pVR25KFIAzzc7yhIoggIP7/T3WbKp4zs/uyD5lQYNKkbY7joBACbc6RtZa2bSPHZ+f2h917Bx7Hkbqu+xPDMFATY6ScEot60lrTuq7C8zzTsiwvUONeqd+Cfd8LRHDfd7pKoSSigVLO5L0nY4w4FkG9vI0AvC3MeDN8r5Sitm1vQXwoj6AwO8YYItcHnyFqrRHB2gTRBXZ7z8ZYadagy3VdlM9Mmd3pVcucpmn6xNaf2GClJnGDfzVqrRvMAF0hep6nuMI5RXYYDq7ZbbwXh3kDwYfbOTs2D9BMIqMDCoghNuIC1Q0Ybr8XBNTFgSH0zhAxS7lErHb7XsB/8QMSX/56Ry6qfwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='fix query result' title='' src='/static/f1eca4cc692652b7660fad5cce349c81/ca1dc/fix-query-result.png' srcset='/static/f1eca4cc692652b7660fad5cce349c81/e7570/fix-query-result.png 170w,\n/static/f1eca4cc692652b7660fad5cce349c81/f46e7/fix-query-result.png 340w,\n/static/f1eca4cc692652b7660fad5cce349c81/ca1dc/fix-query-result.png 680w,\n/static/f1eca4cc692652b7660fad5cce349c81/02d09/fix-query-result.png 1020w,\n/static/f1eca4cc692652b7660fad5cce349c81/c3ac1/fix-query-result.png 1057w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>OR 연선자에 해당하는 데이터들은 모두 <code class=\"language-text\">Index Scan</code>을 통해 조회했고, 그 후에 기본 조건들을 적용했습니다.</p>\n<p>최종적으로 <strong><code class=\"language-text\">기존 67ms</code> 쿼리 실행 시간에서 0.5ms 로 134배 향상되었음을 확인할 수 있습니다.</strong></p>\n<p>하지만 JOIN을 통해 태그 정보를 가져오는 것이아닌, 인자로 유저의 관심 태그를 보유한 <code class=\"language-text\">article.id</code> 목록을 가져오는 것이기 때문에 발생하는 쿼리가 늘어난다는 단점이 존재합니다. </p>\n<p>그럼에도 불구하고 조인을 제거하고, 단일 테이블 조건으로 바꾼 덕분에 쿼리의 속도, 인덱스 효율, 캐시 적중률이 압도적으로 좋아졌고 총 쿼리의 수가 N+1 문제와 같이 치명적인 수준의 쿼리의 개수가 늘어난 것임이 아니기 때문에 적절한 개선 방법이라고 생각합니다.</p>\n<h3 id=\"마무리\" style=\"position:relative;\"><a href=\"#%EB%A7%88%EB%AC%B4%EB%A6%AC\" aria-label=\"마무리 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>마무리</h3>\n<hr>\n<p>결과적으로 의미있는 성능 개선의 경험을 할 수 있었습니다. 위 방법처럼 쿼리 플랜을 통해 쿼리를 분석한다면 성능 개선에 더욱 더 도움이 될 수 있습니다. 하지만 저런식으로 나오는 쿼리 플랜의 결과물은 다소 가독성이 떨어집니다. 그래서 이를 보기 좋게 시각화 해주는 툴을 소개해주도록 하겠습니다.</p>\n<p>먼저 분석하고자 하는 쿼리에 다음과 같은 키워드를 추가합니다</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># 기존</span>\n<span class=\"token keyword\">EXPLAIN</span> <span class=\"token keyword\">ANALYZE</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">SQL</span>\n\n<span class=\"token comment\"># 변경</span>\n<span class=\"token keyword\">EXPLAIN</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">ANALYZE</span><span class=\"token punctuation\">,</span> COSTS<span class=\"token punctuation\">,</span> VERBOSE<span class=\"token punctuation\">,</span> BUFFERS<span class=\"token punctuation\">,</span> FORMAT<span class=\"token punctuation\">,</span> JSON<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">SQL</span></code></pre></div>\n<p>해당 쿼리의 결과물을 <a href=\"https://explain.dalibo.com/\">https://explain.dalibo.com/</a> 의 Plan 부분에 붙여넣고 전송하게 되면 쿼리 플랜을 시각화하여 볼 수 있습니다.</p>","frontmatter":{"title":"실무에서 쿼리 플랜을 통한 성능 개선 경험 (feat. 134배 향상)","date":"June 17, 2025","update":"June 17, 2025","tags":["성능개선","쿼리플랜","실무"],"series":"성능 개선 사례"},"fields":{"slug":"/query-plan-analysis/","readingTime":{"minutes":14.995}}},"seriesList":{"edges":[{"node":{"id":"4f994ee6-e418-58a7-8365-6da206920a84","fields":{"slug":"/query-plan-analysis/"},"frontmatter":{"title":"실무에서 쿼리 플랜을 통한 성능 개선 경험 (feat. 134배 향상)"}}}]},"previous":{"fields":{"slug":"/redis-sentinel/"},"frontmatter":{"title":"Redis-Sentinel에 대해 알아보고 직접 구현해보기"}},"next":{"fields":{"slug":"/nfd-nfc/"},"frontmatter":{"title":"문자열이 자소분리가 되어 DB 저장되는 이슈 해결"}}},"pageContext":{"id":"4f994ee6-e418-58a7-8365-6da206920a84","series":"성능 개선 사례","previousPostId":"d1f5a049-8286-5c64-930b-e22cdf15c246","nextPostId":"23296bb3-0599-505a-9428-18da13466758"}},"staticQueryHashes":[],"slicesMap":{}}