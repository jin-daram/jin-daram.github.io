{"componentChunkName":"component---src-templates-post-jsx","path":"/nestjs-tx-principle/","result":{"data":{"site":{"siteMetadata":{"title":"Let's solve it"}},"markdownRemark":{"id":"1d415206-52d9-5e9a-9f23-3e51637ad48d","excerpt":"Spring Boot 에서는 다음과 같은 코드로 간단하게  을 적용할 수 있다.  자세한 적용 원리나 옵션에 대해서는 의 @Transactional Annotation에 대해 학습이 필용하지만, 위 방법으로 단순하고 간단하게 을 적용할 수 있다. 이것이 가능하게 하는 것이 바로 AOP (Aspect-Oriented Programming, 관점 지향 프로그…","html":"<p><strong>Spring Boot</strong> 에서는 다음과 같은 코드로 간단하게 <code class=\"language-text\">트랜잭션</code> 을 적용할 수 있다. </p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserService</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">UserRepository</span> userRepository<span class=\"token punctuation\">;</span>\n    \n    <span class=\"token annotation punctuation\">@Transactional</span> <span class=\"token comment\">// 트랜잭션 적용</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">createUser</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">UserCreateRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">User</span> user <span class=\"token operator\">=</span> userRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>자세한 적용 원리나 옵션에 대해서는 <code class=\"language-text\">Spring Boot</code>의 <a href=\"https://docs.spring.io/spring-framework/reference/data-access/transaction/declarative/annotations.html\">@Transactional</a> Annotation에 대해 학습이 필용하지만, 위 방법으로 단순하고 간단하게 <code class=\"language-text\">트랜잭션</code>을 적용할 수 있다.</p>\n<p>이것이 가능하게 하는 것이 바로 <strong>AOP (Aspect-Oriented Programming, 관점 지향 프로그래밍, 이하 AOP)</strong> 이다.</p>\n<h2 id=\"AOP\" style=\"position:relative;\"><a href=\"#AOP\" aria-label=\"AOP permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>AOP?</h2>\n<hr>\n<blockquote>\n<p>AOP 설명을 목적으로 하는 포스트는 아니기 때문에 단순하게 설명함으로 양해 부탁드립니다. 자세한 이론적인 내용은 <a href=\"https://ko.wikipedia.org/wiki/%EA%B4%80%EC%A0%90_%EC%A7%80%ED%96%A5_%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D\">위키백과 - AOP</a> 를 참고 하길 바랍니다.</p>\n</blockquote>\n<p>쉽게 말하자면 <code class=\"language-text\">비즈니스 로직은  건들지 않고, 공통적으로 해야 하는 일을 앞, 뒤로 끼워넣는 프로그래밍 기법</code> 이다.\n<br></p>\n<p>만약 프로젝트 내 모든 메소드의 실행 시간을 기록해야 한다면 어떨까?</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">login</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">long</span> startTime <span class=\"token operator\">=</span> <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token comment\">// 비즈니스 로직</span>\n\tlog endTime <span class=\"token operator\">=</span> <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>endTime <span class=\"token operator\">-</span> startTime <span class=\"token operator\">+</span> <span class=\"token string\">\"ms\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 코드와 같은 포맷이 모든 메소드에 추가 되어야 할 것이다. 하지만 다음과 같이 구현한다면?</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Measure</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">login</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token comment\">// 비즈니스 로직</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>단순히 <code class=\"language-text\">@Measure</code> 을 붙이는 것만으로 해결할 수 있다면 우리는 비즈니스 로직 앞 뒤에 아무것도 붙이지 않고, 깨끗하게 비즈니스 로직에만 집중 할 수 있다. 사실 메소드 소요 시간 측정은 정말 가벼운 기능이 추가되는 것이지만, 더 복잡한 로직이 생기게 된다면, 비즈니스 로직보다 공통 로직이 더 많은 부분을 차지하는 기이한 현상이 벌어질 수 있다.</p>\n<p>그렇기 때문에 Spring Boot 환경에서는 <code class=\"language-text\">@Transactional</code> Annotation을 통해 간단하게 <code class=\"language-text\">트랜잭션</code> 을 적용할 수 있는 방법을 제공한다.</p>\n<h2 id=\"Nodejs-환경에서의-트랜잭션\" style=\"position:relative;\"><a href=\"#Nodejs-%ED%99%98%EA%B2%BD%EC%97%90%EC%84%9C%EC%9D%98-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98\" aria-label=\"Nodejs 환경에서의 트랜잭션 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>Node.js 환경에서의 트랜잭션</h2>\n<hr>\n<p>트랜잭션은 Node.js 환경에서도 물론 필요하다. 그렇기 때문에 적용할 수 있어야 한다. 하지만 관심을 가지지 않으면 단독적으로 트랜잭션이 적용될 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Injectable</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserService</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>\n\t\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> userRepository<span class=\"token operator\">:</span> UsreRepository<span class=\"token punctuation\">,</span>\n\t\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> UserDetailRepository<span class=\"token operator\">:</span> UserDetailRepositoty\n\t<span class=\"token punctuation\">)</span>\t<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n\t<span class=\"token function\">createUser</span><span class=\"token punctuation\">(</span>request<span class=\"token operator\">:</span> UserCreateRequest<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">const</span> user <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>userRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">const</span> userDetail <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>userDetailRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>우리의 기대와 달리, 트랜잭션이 <code class=\"language-text\">userRepository.save()</code> 와 <code class=\"language-text\">userDetailRepository.save()</code> 에 각각 적용된다.\n어느 하나라도 실패가 된다면, 다른 쿼리도 <code class=\"language-text\">Rollback</code>  이 되어야 하지만, 실패해도 롤백이 이루어지지 않는다.</p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/13bf03fb35bdb35abb81099c00d48758/39b47/double-tx-image.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 12.352941176470589%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAdUlEQVR42jXNSw7CMAwE0N6kKP7FpE0TCZCAsoT732hwVFhYY1vW89R7w2X/4PZ64/HcUWuFiCJnQxIHWwap4qRLpCOxQGJm5rgT6K8fRUSYemuw7Q5ZryjLilLOgeWjzODumHnABgpgti0ynlCCxe4PDXyAX7i0OuFJj26iAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='개별적으로 트랜잭션이 적용되는 모습' title='' src='/static/13bf03fb35bdb35abb81099c00d48758/ca1dc/double-tx-image.png' srcset='/static/13bf03fb35bdb35abb81099c00d48758/e7570/double-tx-image.png 170w,\n/static/13bf03fb35bdb35abb81099c00d48758/f46e7/double-tx-image.png 340w,\n/static/13bf03fb35bdb35abb81099c00d48758/ca1dc/double-tx-image.png 680w,\n/static/13bf03fb35bdb35abb81099c00d48758/02d09/double-tx-image.png 1020w,\n/static/13bf03fb35bdb35abb81099c00d48758/9d567/double-tx-image.png 1360w,\n/static/13bf03fb35bdb35abb81099c00d48758/39b47/double-tx-image.png 2034w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>개별적으로 트랜잭션이 적용되는 모습</figcaption>\n  </figure></p>\n<p>TypeORM 설정에서 <code class=\"language-text\">logging</code> 옵션을 <code class=\"language-text\">true</code> 로 두고 <code class=\"language-text\">데이터베이스 로그</code> 를 확인해보면 트랜잭션이 각각 분리되어 전송되는 것을 확인할 수 있다. </p>\n<p>만약 둘 중 하나가 실패한다면? 정상적으로 롤백이 이루어질까? 일부러 둘 중 하나의 로직이 실패하게 유도하고 결과를 지켜보자.</p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 374px; '>\n      <a class='gatsby-resp-image-link' href='/static/c39cd1c8c9a267193cf6f59e629867c9/b0af8/no-rollback-result.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 73.52941176470587%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAACyUlEQVR42pVTa28SQRTd/2AfRi2PPsSyy5vdhe3yhiUs77bQQmlLa4ECTasxVqNJE6OJ8YuJf5aPe7wzWyypX/TDyd07O/fMmXvPCLrZQqZURaW5B92oYqe0i87xJfqjW1xd3WIyvcVp/wonp1OcnExw/PodWr0RtGIDhdo+Ggc9ZM2apRk16KXmTIgTYcKoEOE+4jkT8UIVB70pehcfcHP9GZPJR3Q7ExvdMTq9G7Q6I+jlNsy9LlpHZ8iVG5aaKSGer84ELRaDz+eDKErw+/0UvSibJoaDAcbjCUajEQb0PZ1OcHZ+juFwiFwui3qthna7jVAoDK8oWoFAgPHMhEAgSCQiJEnixPOoKAo0TYMsy5CjUZ5HIhGes/8MwWCQi6Aai9URz0wIh8Ng7Ozn/SLfxDA/YH7IIuZ7WC2BK6R8JmxtbcHpdHIwcqZifX0dbrebY67kvhD21R7I/DaRZQsgQpfTgaerq1haWkY6lYJRyOPF82dYWX6ClZUleDwv4fVuU5+8pH4bEt3AxyCJvN8890lWgCkXvTNBSeSgJDJIZbKIxHT4FB2JbBHVZgfV+iGaux3st45Qr7fJCUcwzCZkPYN4Kod0vohEpoB4MmsptCanCjNBr3SgVQ7R6vZQouKo0US53cfFzXdcv/+Bb19/4e7uJ8aXn3A+/oLu2VvEKl00ewNcTN+gf3mNRqdvMbtp5UPyoZ6ErMYRVTUosR3ISgzaTpKubiKfn6OEPOVsLUOKlJjGEaU6mSLBUnmtSlOmIbB++Pn0JB5ZX1jfRN63v2Hvs/fakCxeL0kzIRKV+cSCoZANmujjqS6C22U+3QdYLPqYbcKRKPlMpGl6wCzE4ubmJvfjot8Wvfl47cE29FLcGxtYW1tDilnGMFAsFmHS02Pkq2QnRvxH2b8Qel5tw+VyQVVVJJNJ/tzS6TQndDgc/JX8D+FvUX33GYQBovMAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='User 테이블은 데이터 저장, UserDetail 테이블은 Rollback' title='' src='/static/c39cd1c8c9a267193cf6f59e629867c9/b0af8/no-rollback-result.png' srcset='/static/c39cd1c8c9a267193cf6f59e629867c9/e7570/no-rollback-result.png 170w,\n/static/c39cd1c8c9a267193cf6f59e629867c9/f46e7/no-rollback-result.png 340w,\n/static/c39cd1c8c9a267193cf6f59e629867c9/b0af8/no-rollback-result.png 374w' sizes='(max-width: 374px) 100vw, 374px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>User 테이블은 데이터 저장, UserDetail 테이블은 Rollback</figcaption>\n  </figure></p>\n<p>예상했던 결과처럼 <code class=\"language-text\">User</code> 테이블에는 데이터가 성공적으로 삽입되었고, 에러가 발생한 <code class=\"language-text\">UserDetail</code> 데이터는 삽입되지 않았다.</p>\n<h2 id=\"트랜잭션-적용하기\" style=\"position:relative;\"><a href=\"#%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EC%A0%81%EC%9A%A9%ED%95%98%EA%B8%B0\" aria-label=\"트랜잭션 적용하기 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>트랜잭션 적용하기</h2>\n<hr>\n<p>지금까지 트랜잭션이 정상적으로 적용되지 않는다는 것을 알 수 있었다. 이제 NestJS과 TypeORM에서 지원하는 트랜잭션 적용 방법을 알아보도록 하겠다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Injectable</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserService</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">private</span> dataSource<span class=\"token operator\">:</span> DataSource<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">async</span> <span class=\"token function\">createUser</span><span class=\"token punctuation\">(</span>request<span class=\"token operator\">:</span> UserCreateRequest<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">const</span> queryRunner <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>dataSource<span class=\"token punctuation\">.</span><span class=\"token function\">createQueryRunner</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\n\t\t<span class=\"token keyword\">await</span> queryRunner<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">await</span> queryRunner<span class=\"token punctuation\">.</span><span class=\"token function\">startTransaction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// TRANSACTION START</span>\n\n\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">const</span> user <span class=\"token operator\">=</span> queryRunner<span class=\"token punctuation\">.</span>manager<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>User<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">await</span> queryRunner<span class=\"token punctuation\">.</span>manager<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// User 저장</span>\n\t\t\t\n\t\t\t<span class=\"token keyword\">const</span> detail <span class=\"token operator\">=</span> queryRunner<span class=\"token punctuation\">.</span>manager<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>UserDetail<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">await</span> queryRunner<span class=\"token punctuation\">.</span>manager<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>detail<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// UserDetail 저장</span>\n\t\t\t\n\t\t\t<span class=\"token keyword\">await</span> queryRunner<span class=\"token punctuation\">.</span><span class=\"token function\">commitTransaction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// COMMIT</span>\n\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">await</span> queryRunner<span class=\"token punctuation\">.</span><span class=\"token function\">rollbackTransaction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">throw</span> err<span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">await</span> queryRunner<span class=\"token punctuation\">.</span><span class=\"token function\">release</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\t\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>심히 당황스럽다.</strong></p>\n<p>핵심 로직은 엔티티를 생성하고, 저장하는 <code class=\"language-text\">4줄</code> 밖에 되지 않는다. 하지만 트랜잭션 로직 때문에 간단한 <code class=\"language-text\">createUser()</code> 함수가 거대해졌다. 혹시라도 함수의 내용이 방대해지거나, 분리가 필요하면 트랜잭션의 추적도 쉽지 않을 것이다.</p>\n<blockquote>\n<p><strong>DataSource를 의존성 주입을 받을 수 있는 이유</strong></p>\n<p><code class=\"language-text\">@nestjs/typeorm</code> 의존성을 통해 <code class=\"language-text\">TypeOrmModule</code> 을 import 하면 내부에서 <code class=\"language-text\">DataSource</code> , <code class=\"language-text\">EntityManager</code> 등을 기본적으로 <code class=\"language-text\">Provider</code>로 추가한다.\n<br> 실제 코드는 <a href=\"https://github.com/nestjs/typeorm/blob/master/lib/typeorm-core.module.ts\">@nestjs/typeorm typeorm-core-module.ts</a> 에서 확인할 수 있다.</p>\n</blockquote>\n<p>그럼 다음과 같은 코드는 작동하지 않을까? </p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Injectable</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserService</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> em<span class=\"token operator\">:</span> EntityManager<span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> userRepository<span class=\"token operator\">:</span> UserRepository<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">async</span> <span class=\"token function\">createUser</span><span class=\"token punctuation\">(</span>userCreateRequest<span class=\"token operator\">:</span> UserCreateRequest<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>em<span class=\"token punctuation\">.</span><span class=\"token function\">transaction</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>manager<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>userRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>userCreateRequest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/72d02875930c5b3a7dc34d79088a7f26/a52c7/nested-tx-image.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 8.823529411764705%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAbElEQVR42j2M0Q3CQAxDOwkksdODEz8doRJVJSTYfxtzOQm+nmM7Xvbzo/P11nE81XsXSbXW5Gwy3oSEPJuu60McjIiZZ6YATNZP+cUltl3mmMcvzKQsUoZVIIamLrgrODyz2akxd//rGix+AZrSOgltq3QdAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='트랜잭션이 중첩되는 모습' title='' src='/static/72d02875930c5b3a7dc34d79088a7f26/ca1dc/nested-tx-image.png' srcset='/static/72d02875930c5b3a7dc34d79088a7f26/e7570/nested-tx-image.png 170w,\n/static/72d02875930c5b3a7dc34d79088a7f26/f46e7/nested-tx-image.png 340w,\n/static/72d02875930c5b3a7dc34d79088a7f26/ca1dc/nested-tx-image.png 680w,\n/static/72d02875930c5b3a7dc34d79088a7f26/02d09/nested-tx-image.png 1020w,\n/static/72d02875930c5b3a7dc34d79088a7f26/9d567/nested-tx-image.png 1360w,\n/static/72d02875930c5b3a7dc34d79088a7f26/a52c7/nested-tx-image.png 2024w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>트랜잭션이 중첩되는 모습</figcaption>\n  </figure></p>\n<p>결과는 기대했던 결과와는 달리 <code class=\"language-text\">트랜잭션</code>이 중첩되어 실행된다.</p>\n<p>결론부터 말하자면, <code class=\"language-text\">UserService의 EntityManager</code> 와 <code class=\"language-text\">UserRepository의 EntityManager</code>가 서로 다른 참조를 하고 있다는 것이다.  </p>\n<p><code class=\"language-text\">UserService</code> 에 주입된 <code class=\"language-text\">EntityManager</code>의 <code class=\"language-text\">transaction</code>을 통해 생성된 <code class=\"language-text\">EntityManager</code> 와 <code class=\"language-text\">UserRepository</code> 에서 참조하는 <code class=\"language-text\">EntityManager</code> 는 같지 않다. </p>\n<p>이는 <a href=\"\">TypeORM 공식 Github</a> 코드를 통해 확인 할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">/* typeorm/src/entity-manager/EntityManager.ts  */</span>\n\n<span class=\"token keyword\">async</span> <span class=\"token generic-function\"><span class=\"token function\">transaction</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token comment\">// 만약 해당 클래스에 QueryRunner가 이미 할당되어있다면, EntityManager가</span>\n\t<span class=\"token comment\">// 이미 Single Connection을 생성한 것 입니다.</span>\n\t<span class=\"token comment\">// 만약 정의되지 않은 경우, 모든 작업을 실행할 새로운 Single Connection을 생성합니다.</span>\n\t<span class=\"token keyword\">const</span> queryRunner <span class=\"token operator\">=</span>\n\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>queryRunner <span class=\"token operator\">||</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">.</span><span class=\"token function\">createQueryRunner</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이 코드는 공식 <code class=\"language-text\">TypeORM</code>의 <code class=\"language-text\">EntityManager.ts</code> 의 코드 중 <code class=\"language-text\">transaction()</code> 함수 중 일부를 발췌한 것이다. 해당 코드는 쿼리 시에 사용할 <code class=\"language-text\">QueryRunner</code> 를 정의하는데, 이미 사용하고 있는 <code class=\"language-text\">QueryRunner</code> 가 없다면 새로운 <code class=\"language-text\">QueryRunner</code> 를 생성한다. </p>\n<p><code class=\"language-text\">this.connection.createQueryRunner()</code> 함수를 통해 새로운 <code class=\"language-text\">QueryRunner</code> 를 생성하게 되는데 이는 <code class=\"language-text\">DataSource.ts</code> 의 <code class=\"language-text\">createQueryRunner()</code> 와 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">/* typeorm/src/data-source/DataSource.ts */</span>\n\n<span class=\"token function\">createQueryRunner</span><span class=\"token punctuation\">(</span>mode<span class=\"token operator\">:</span> ReplicationMode <span class=\"token operator\">=</span> <span class=\"token string\">\"master\"</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> QueryRunner <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">const</span> queryRunner <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>driver<span class=\"token punctuation\">.</span><span class=\"token function\">createQueryRunner</span><span class=\"token punctuation\">(</span>mode<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">const</span> manager <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">createEntityManager</span><span class=\"token punctuation\">(</span>queryRunner<span class=\"token punctuation\">)</span>\n\tObject<span class=\"token punctuation\">.</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span>queryRunner<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> manager<span class=\"token operator\">:</span> manager <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">return</span> queryRunner\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">createEntityManager</span><span class=\"token punctuation\">(</span>queryRunner<span class=\"token operator\">?</span><span class=\"token operator\">:</span> QueryRunner<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> EntityManager <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">EntityManagerFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> queryRunner<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token operator\">...</span></code></pre></div>\n<p>실질적인 <code class=\"language-text\">QueryRunner</code> 는 각 <code class=\"language-text\">Database Driver</code> 를 구현한 구현체에 맡기고, <code class=\"language-text\">EntityManager</code> 는 <code class=\"language-text\">DataSource.ts</code> 에 정의된 <code class=\"language-text\">createEntityManager()</code> 함수를 통해 생성하여, <code class=\"language-text\">QueryRunner</code> 의 <code class=\"language-text\">manager</code> 에 저장한다. </p>\n<p>그렇기 때문에 <code class=\"language-text\">UserService</code> 에 주입된 <code class=\"language-text\">EntityManager</code> 와 <code class=\"language-text\">UserRepository에서</code> 참조하는 <code class=\"language-text\">EntityManager</code> 가 서로 다른 객체를 참조하고 있는 것이다.</p>\n<p>그럼 어떻게 <code class=\"language-text\">EntityManager.transaction()</code> 의 인자로 주어진 함수에서 같은 <code class=\"language-text\">EntityManager</code> 를 사용할 수 있을까? </p>\n<p>이 내용은 앞서 이야기 했던 <code class=\"language-text\">AOP</code> 라는 주제와 함꼐 직접 <code class=\"language-text\">@Transactional</code> 을 구현하여, 적용해보는 내용을 <a href=\"\">다음 글</a> 에 소개하도록 하겠다.</p>","frontmatter":{"title":"NestJS 트랜잭션 적용 원리 알아보기","date":"June 05, 2025","update":"June 05, 2025","tags":["Node.js","NestJS","트랜잭션","TypeORM"],"series":"NestJS 트랜잭션 다루기"},"fields":{"slug":"/nestjs-tx-principle/","readingTime":{"minutes":8.51}}},"seriesList":{"edges":[{"node":{"id":"1d415206-52d9-5e9a-9f23-3e51637ad48d","fields":{"slug":"/nestjs-tx-principle/"},"frontmatter":{"title":"NestJS 트랜잭션 적용 원리 알아보기"}}}]},"previous":{"fields":{"slug":"/intellij-zoom-issue/"},"frontmatter":{"title":"IntelliJ Mouse Wheel Zoom 이슈"}},"next":null},"pageContext":{"id":"1d415206-52d9-5e9a-9f23-3e51637ad48d","series":"NestJS 트랜잭션 다루기","previousPostId":"ce12447b-479a-5517-9dc7-ee7766b5c879","nextPostId":null}},"staticQueryHashes":[],"slicesMap":{}}